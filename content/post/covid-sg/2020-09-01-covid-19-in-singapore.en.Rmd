---
title: A Short Story of COVID-19 in Singapore
author: Brendi Ang
date: '2020-09-01'
slug: covid-19-in-singapore
categories:
  - R
tags:
  - R Markdown
  - Academic
subtitle: ''
summary: ''
authors: []
lastmod: '2020-09-01T22:09:55+10:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
bibliography: [references.bib]
link-citations: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, echo = FALSE)

# Load library
library(tidyverse)
library(coronavirus) # devtools::install_github("RamiKrispin/coronavirus")
library(DT)
library(gganimate)
library(janitor)
library(lubridate)
library(plotly)
library(tidycovid19) # remotes::install_github("joachim-gassen/tidycovid19")
library(transformr)
library(readxl)
library(stringr)
library(timevis)
library(widgetframe)
library(zoo)
library(scales)
```

The Covid-19 pandemic has altered people's lives, be it enormous or minute. Undoubtedly, there will be many stories told of how they 'survived' this pandemic down the road, fighting for toilet papers and masks and how bumping elbows were the norm etc. As a student, I'd like to add that group assignments studying online is a chore when you can't have face-to-face conversations. 

My first blog post is a short story of the COVID-19 situation in my home country, Singapore.

## Data Description 

`coronavirus` depicts details of coronavirus cases for all countries from 22-01-2020. It is in a long format where each observation represents a detailed summary of COVID-19 cases by country. I've chosen to use this data set in conjunction with the `merged_df` data set the data is in a long format and will be handy when plotting and constructing tables.

```{r read-in-data}
# From coronavirus package: long format of covid cases
sg_long <- coronavirus %>% 
  filter(country == "Singapore",
         date != "2020-01-22") %>% # Show first case recorded onwards
  select(-c(province, lat, long)) # No province in Singapore

# Load data for all countries
merged_df <- download_merged_data(cached = TRUE, silent = TRUE) 

sg_df <- merged_df %>%
  filter(country == "Singapore")
```

```{r wrangle-gdp, include = FALSE}
# read-in GDP data
sg_gdp <- read_excel("OutputFile.xlsx")

sg_gdp <- sg_gdp %>%
  filter(!is.na(Variables)) %>%
  slice(1:(n()- 3))  # Remove last 3 rows relating to contact info

# Transpose data
sg_gdp <- as.data.frame(t(as.matrix(sg_gdp))) 

colnames(sg_gdp) <- sg_gdp[1,] 

sg_gdp <- sg_gdp %>% #
  slice(-1)

# Add Year variable& tidy data set 
sg_gdp <- sg_gdp %>%
  rownames_to_column('Year') %>%
  janitor::clean_names() # Remove spacings in variable names

```

In this blog, three main data sets will be used.


## A Timeline of for Covid-19 in Singapore

```{r, outwidth = 12}
time_vis <- tribble (~id, ~content, ~start, ~end,
      1, "First Case detected, man from Overseas", "2020-01-23", NA, 
      2, "First local case", "2020-02-04", NA, 
      3, "Dorscon level changed (yellow to orange), wave of panic buyers ensued", "2020-02-07", NA, 
      4, "First death from the virus", "2020-03-21", NA, 
      5, "Bars, cinemas and entertainment outlet closes", "2020-03-26", NA,
      6, "Commencement of first lockdown", "2020-04-07", "2020-06-01",
      7, "Mandatory mask wearing", "2020-04-14", NA,
      8, "Changi Airport Terminal 2 suspends operations for 18 months", "2020-04-30", NA,
      9, "End of first lockdown, school reopens", "2020-06-01", NA,
      10, "Singapore General Election held", "2020-07-10", NA)
 
timevis(time_vis)
```


### Animation for covid cases

```{r sg-phases}
# Duration of each government intervention 
sg_long <- sg_long %>%
  mutate(phase =
           case_when(
          between(date, as.Date("2020-01-22"), as.Date("2020-04-06")) ~ "No lockdown",
          between(date, as.Date("2020-04-07"), as.Date("2020-06-01")) ~ "First Lockdown",
          between(date, as.Date("2020-06-02"), as.Date("2020-06-17")) ~ "Phase 1 (Safe Reopening)",
          between(date, as.Date("2020-06-18"), as.Date("2020-09-01")) ~ "Phase 2 (Safe Transition)")
         )

# Compute 3-day Rolling average 
sg_long <- sg_long %>%
  group_by(type) %>%
  # 3-day rolling average
  mutate(rolling_avg_cases = round(zoo::rollmean(cases, k = 3, fill = 0), digits = 2), 
         cum_cases = cumsum(cases)) %>% # cumulative cases for each case type
  relocate(phase, .after = cum_cases)

# daily changes in cases
sg_long <- sg_long %>%
  mutate(lag_cases = lag(cum_cases, k = 1)) %>%
  mutate(daily_prop_change = (cum_cases - lag_cases)/lag_cases)

# Start and end date for each government intervention
lockdown_dur <- sg_long %>% 
  group_by(phase) %>%
  summarise(start = min(date),
            end = max(date))
```

```{r static-cases}
# Static plot: 3-day rolling averages
p1 <- ggplot(sg_long) +
  # plot covid cases
  geom_line(aes(x = date,
                y = rolling_avg_cases,
                colour = type),
            alpha = 0.8) +
  theme_bw() +
  scale_colour_manual(values = c("#bc3a3a", "#00468b" ,"#468b00")) +
  theme(legend.position = "bottom") +
  scale_x_date(date_breaks = "1 week", 
               date_labels = "%b %d") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.grid.minor.x = element_blank()) +
  ggtitle("Number of confirmed, death and recovered COVID-19 Cases") +
  # Colour each phase of government intervention 
  geom_rect(data = lockdown_dur,
            aes(xmin = start, 
                xmax = end,
                ymin = -Inf, 
                ymax = Inf,
                fill = phase),
            alpha = 0.15) +
  scale_fill_manual(values = c('#c74848', '#228b57', '#72bcd4', '#a284e0'))
```

```{r animate-cases}
# p1 + transition_reveal(date)
# Show which lockdown phase the plot is on during animation
# Show what major events were taking place at this time (e.g. general election or surge in dorm cases)
# Play and stop button
# Annotate important dates
```

Why so little death? Is it attributed to great hospital equipment? Were there times when hospitals were over capacity?

*Key Observations*  
- People recover in about 2 weeks
- Very low death rates, almost 0 


## Interactive table (with data story)

```{r}
# Replace inf, NaN and NA values with zero
sg_long$daily_prop_change[!is.finite(sg_long$daily_prop_change)] <- 0

# sg_long$daily_prop_change <- scales::percent(round(sg_long$daily_prop_change), digits = 4)

sg_long <- sg_long %>%
  mutate(daily_prop_change = round(daily_prop_change, digits = 2)) %>%
         # daily_prop_change = scales::percent(daily_prop_change)) %>%
  mutate(type = str_to_title(type)) # Capitalise first letter

# Rearrange table
tb1 <- sg_long %>%
  select(-c(country, lag_cases)) %>%
  relocate(phase, .after = daily_prop_change) %>%
  relocate(rolling_avg_cases, .before = daily_prop_change)
```

```{r}
tb1_interactive <- DT::datatable(tb1,
              colnames = c('Date Recorded', 
                           'Case Type', 
                           'Number of Cases',
                           'Cumulative Cases',
                           '3-day Rolling Average Cases',
                           'Daily Change in Cases (%)',
                           'Phase'
                           ),
              filter = 'top',
              rownames = FALSE,
              extensions = "Scroller",
              options = list(pageLength = 10,
                             autoWidth = TRUE,
                             scrollY = "250px")) %>%
  formatPercentage('daily_prop_change', digits = 2) %>% # Format proportion to percentage
  formatStyle(c('daily_prop_change'), `text-align` = 'right') %>% # Align values to the right 
  # Colour background of each lockdown stage
  formatStyle('phase',
              backgroundColor = styleEqual(
                unique(tb1$phase), c('#df9797', '#bfd9bf', '#d4ebf2', '#869cda'))
              ) 

# Frame table
widgetframe::frameWidget(tb1_interactive)
```


## COVID-19 impact on Singapore's economy

Undoubtedly, COVID-19 would have impact on Singapore's Economy. In this section, we will investigate which sector are most adversely affected by the outbreak.

```{r wrangle-sgp-gdp}
# Convert character variables to numeric
sg_gdp <- sg_gdp %>%
  mutate(across(gdp_at_current_market_prices:add_taxes_on_products, as.numeric))

# Change quarter to date
sg_gdp <- sg_gdp %>%
  separate(year, into = c("year", "qtr"), sep = " ") %>% # separate year and quarter
  mutate(qtr = parse_number(qtr)) %>% # parse number for quarter 
  mutate(qtr = case_when(
    qtr == 1 ~ "03-31",
    qtr == 2 ~ "06-30",
    qtr == 3 ~ "09-30",
    qtr == 4 ~ "12-31"
  ))

sg_gdp <- sg_gdp %>%
  rowwise() %>%
  mutate(date = paste0(year, "-", qtr)) %>%
  mutate(date = as.Date(date)) %>%
  relocate(date, .before = gdp_at_current_market_prices) %>%
  select(-c(year, qtr))
```

```{r gdp-long}
# Convert GDP dataset to long format for plotting

# Create subgroups for the sectors
sg_gdp_long <- sg_gdp %>%
  # Keep aggregated scores together so it doesn't get 'pivoted'
  relocate(services_producing_industries, .before = manufacturing) %>% 
  pivot_longer(cols = manufacturing:ownership_of_dwellings,
               names_to = "Sector",
               values_to = "Sector_GDP") %>%
  # Categorise each sector according to their respective industry
  mutate(industry = case_when(
    Sector %in% c("manufacturing", "construction", "utilities", "other_goods_industries") ~ "goods",
    Sector %in% "ownership_of_dwellings" ~ "ownership",
    TRUE ~ "services")
    ) %>%
  # Capitalise first words of character string
  mutate(industry = str_to_title(industry),
         Sector = str_to_title(Sector)) 

# Compute GDP before taxes, to be consistent with sectors           
sg_gdp_long <- sg_gdp_long %>%
  mutate(gdp_at_current_market_prices = gdp_at_current_market_prices - add_taxes_on_products) %>%
  select(-c(add_taxes_on_products, gross_value_added_at_basic_prices)) %>%
  mutate(across(where(is.character), as.factor)) # Convert character strings to factor
```

```{r}
# Compute summary statistics at industry level
ind_summary <- sg_gdp_long %>%
  group_by(date, industry) %>%
  summarise(total = sum(Sector_GDP)) %>%
  mutate(month = month(date)) %>%
  # Quarter of each year
  mutate(qtr = month/3) %>%
  select(-month)
  
p2 <- ind_summary %>% 
  # filter(qtr == c(2,4)) %>% # show biannual trend to smooth graph
  ggplot(aes(x = date, 
             y = total)) +
  geom_line(aes(colour = industry)) +
  ggtitle("Quarterly GDP Values for each Industry") +
  theme_bw() +
  theme(legend.position = "bottom") 

p2
```

```{r}
# Find relative change of GDP for each industry per year
ind_change <- ind_summary %>%
  group_by(industry) %>%
  mutate(lag_total = lag(total, k = 1)) %>%
  mutate(pct_change = round((total-lag_total)/lag_total*100, digits = 4)
  ) 

p3 <- ggplot(ind_change) +
  geom_line(aes(x = date,
                y = pct_change,
                colour = industry),
            alpha = 0.8) +
  geom_hline(aes(yintercept = 0),
             alpha = 0.2) +
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap(~ industry,
             ncol = 1,
             strip.position = "top") +
  labs(y = "Quarterly change in GDP (%) for each Industry",
       x = "Date")

p3
```

```{r}
p4 <- sg_gdp_long %>%
  ggplot() +
  geom_line(aes(x = date,
                y = Sector_GDP,
                colour = Sector,
                group = 1,
                # Format legend name for plotly
                text = paste('Date:', date,
                             '<br>Sector:', Sector, 
                             '<br>Sector GDP:', Sector_GDP
                ))) +
  theme(legend.position = "none") +
  facet_wrap(~ industry,
             nrow = 3,
             scales = "free_y") +
  ggtitle("Quartely GDP values for each Sector")

plotly::ggplotly(p4,
                 tooltip = "text")
```

## interactive table

```{r tb2-wrangle}
tb2 <- sg_gdp_long %>%
  # Remove all '_' 
  mutate(Sector = str_replace_all(Sector, "[[:punct:]]", " ")) %>%
  mutate(Sector = str_to_title(Sector)) %>%
  arrange(Sector)

# Take subset of industrial GDP changes
## Join for quarterly GDP changes for industry


tb2 <- tb2 %>%
  inner_join(ind_summary, by = c("date", "industry")) %>%
  rename(industry_total = total) %>%
  select(-qtr)

# Set year to year-quarter variable - Better for eyes
tb2$date <- zoo::as.yearqtr(tb2$date, format = "%Y-%m-%d")

# Rearrange table
tb2 <- tb2 %>%
  select(date, 
         Sector, 
         Sector_GDP, 
         industry, 
         goods_producing_industries,
         services_producing_industries,
         gdp_at_current_market_prices
         )

# add relative changes in sector and industry 
tb2 <- tb2 %>%
  group_by(Sector) %>%
  mutate(lag_sector_GDP = lag(Sector_GDP, k =1)) %>%
  ungroup() %>%
  group_by(industry) %>%
  mutate(lag_industry_GDP = lag(gdp_at_current_market_prices, k =1))  %>%
  mutate(sector_GDP_change = round((Sector_GDP - lag_sector_GDP)/lag_sector_GDP, digits = 4), 
         industry_GDP_change = round((gdp_at_current_market_prices - lag_industry_GDP)/lag_industry_GDP, digits = 4)) %>%
  select(-c(lag_sector_GDP,
            lag_industry_GDP)) %>%
  relocate(sector_GDP_change, .before = industry) %>%
  relocate(industry, .before = Sector_GDP) %>%
  rename(total_GDP = gdp_at_current_market_prices)

# Replace inf, NaN and NA values with zero
tb2$sector_GDP_change[!is.finite(tb2$sector_GDP_change)] <- 0
tb2$industry_GDP_change[!is.finite(tb2$industry_GDP_change)] <- 0

# Convert date to character to allow DT::datatable to read
tb2 <- tb2 %>%
  mutate(date = as.character(date))
```

```{r}
tb2_interactive <- DT::datatable(tb2,
              colnames = c('Date Recorded', 
                           'Sector', 
                           'Sector\'s Industry',
                           'Sector\'s GDP',
                           'Sector\'s Quarterly GDP Change',
                           'Goods Industry\'s GDP',
                           'Services Industry\'s GDP',
                           'Total GDP',
                           'Industry\'s Quarterly GDP Change'
                           ),
              filter = 'top',
              rownames = FALSE,
              extensions = c("Scroller", 
                             "FixedColumns"), # Make columns visible when scrolling
              options = list(pageLength = 10,
                             dom = 't',
                             autoWidth = TRUE,
                             scrollY = "200px",
                             scrollX = TRUE)) %>%
  # Format proportion to percentage
  formatPercentage(c('sector_GDP_change', 'industry_GDP_change'), 
                   digits = 2) 

# Frame table
widgetframe::frameWidget(tb2_interactive)
```

\clearpage

# References



